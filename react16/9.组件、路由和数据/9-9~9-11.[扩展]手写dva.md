# 手写 dva



**index.js**

导出核心模块dva，导出connect

```js
export { default } from './dva';
export { connect } from 'react-redux';
```

**router.js**

导出`connected-react-router`第三方库中的内容合并到routerRedux中，和`react-router-dom`中的内容

```js
import * as routerRedux from 'connected-react-router';
export * from 'react-router-dom';
export { routerRedux };
```

**saga.js**

导出saga指令模块的内容

```js
export * from 'redux-saga/effects';
```



**dva.js**

```js
import React from 'react';
import ReactDOM from 'react-dom';
import { Provider } from 'react-redux';
import {
  legacy_createStore as createStore,
  combineReducers,
  applyMiddleware,
} from 'redux';
import { composeWithDevTools } from '@redux-devtools/extension';
import createSagaMiddleware from 'redux-saga';
import * as sagaEffects from './saga';
import { createHashHistory } from 'history';
import { connectRouter, routerMiddleware } from 'connected-react-router';

/**
 * 创建一个dva对象
 * @param {*} opt 配置对象
 */
export default function (opt = {}) {
  const app = {
    router,
    _router: null,
    model,
    _model: [],
    start,
  };

  const options = mergeOptions(opt);

  /**
   * 返回一个路由配置
   * @param {*} routeFunc 路由配置函数，该函数返回一个react节点
   */
  function router(routeFunc) {
    app._router = routeFunc;
  }

  /**
   * 添加一个模型配置对象
   * @param {*} modelObj 模型配置对象
   */
  function model(modelObj) {
    app._model.push(modelObj);
  }

  function start(selector) {
    const store = getStore();
    initSubscriptions(store);
    render(selector, store);
  }

  //以下是实现功能的辅助函数
  function render(selector, store) {
    const rootDom = (
      <Provider store={store}>
        {app._router({ app, history: options.history })}
      </Provider>
    );
    ReactDOM.render(rootDom, document.querySelector(selector));
  }

  //得到仓库
  function getStore() {
    let reducers = {};
    for (const model of app._model) {
      const reducerObj = mapModelToReducerObject(model);
      reducers[reducerObj.namespace] = reducerObj.fn;
    }
    reducers = { ...reducers, ...getExtraReducer() };
    let rootReducer = combineReducers(reducers);
    let oldRootReducer = rootReducer;
    rootReducer = (state, action) => {
      const newState = oldRootReducer(state, action);
      options.onStateChange(newState);
      return newState;
    };
    let oldRootReducer2 = rootReducer;
    rootReducer = options.onReducer(oldRootReducer2);
    const initStore = options.extraEnhancers
      ? options.extraEnhancers.reduce((fn1, fn2) => {
          return fn1(fn2(createStore));
        })
      : createStore;

    const store = initStore(rootReducer, options.initialState, getMiddleware());
    getMiddleware.runSaga(store);
    return store;
  }

  /**
   * {
   *  namespace:''
   *  reducer:fn
   * }
   */
  function mapModelToReducerObject(model) {
    const reducerObj = {};
    if (model.namespace === undefined || model.state === undefined) {
      throw new Error(`namespace and state can not be undefined`);
    }
    reducerObj.namespace = model.namespace;
    reducerObj.fn = function (state = model.state, action) {
      if (model.reducers) {
        const actionTypesAndReducers = [];
        for (const actionType in model.reducers) {
          actionTypesAndReducers.push({
            type: `${model.namespace}/${actionType}`,
            reducer: model.reducers[actionType],
          });
        }
        const obj = actionTypesAndReducers.find(
          (item) => item.type === action.type
        );
        if (obj) {
          return obj.reducer(state, action);
        } else {
          return state;
        }
      }
      return state;
    };
    return reducerObj;
  }

  function getMiddleware() {
    const sagaMid = createSagaMiddleware();
    getMiddleware.runSaga = function (store) {
      const generatorCreator = function* () {
        //监听model配置中的effects中的每一个action类型
        const allEffects = getAllEffects();
        for (const effectObj of allEffects) {
          const { type, fn, namespace, model } = effectObj;
          const put = function (action) {
            const newAction = initNamespace(action, namespace);
            return sagaEffects.put(newAction);
          };
          const oldEffect = function* (action) {
            try {
              yield fn(action, { ...sagaEffects, put });
            } catch (err) {
              options.onError(err, store.dispatch);
            }
          };
          const effect = options.onEffect
            ? options.onEffect(oldEffect, sagaEffects, model, type)
            : oldEffect;

          yield sagaEffects.takeEvery(type, effect);
        }
      };

      sagaMid.run(generatorCreator);
    };
    return composeWithDevTools(
      applyMiddleware(
        routerMiddleware(options.history),
        sagaMid,
        ...options.onAction
      )
    );
  }

  /**
   * [{
   *  type:'',
   *  fn,
   * namespace:""
   * }]
   */
  function getAllEffects() {
    const effects = [];
    for (const model of app._model) {
      for (const acionType in model.effects) {
        effects.push({
          type: `${model.namespace}/${acionType}`,
          fn: model.effects[acionType],
          namespace: model.namespace,
          model,
        });
      }
    }
    return effects;
  }

  function getExtraReducer() {
    const dva = '@@dva';
    return {
      router: connectRouter(options.history),
      [dva](state = 0, action) {
        return state;
      },
      ...options.extraReducers,
    };
  }

  function initNamespace(action, namespace) {
    let newAction = action;
    if (!action.type.includes('/')) {
      newAction = {
        ...action,
        type: `${namespace}/${action.type}`,
      };
    }
    return newAction;
  }

  function initSubscriptions(store) {
    for (const model of app._model) {
      for (const key in model.subscriptions) {
        const fn = model.subscriptions[key];
        const oldDispatch = store.dispatch;
        store.dispatch = function (action) {
          const newAction = initNamespace(action, model.namespace);
          return oldDispatch(newAction);
        };
        fn({
          dispatch: store.dispatch,
          history: options.history,
        });
      }
    }
  }

  function mergeOptions(opt) {
    const endOptions = {
      history: opt.history || createHashHistory(),
      initialState: opt.initialState === undefined ? {} : opt.initialState,
      onError: opt.onError ? opt.onError : () => {},
      onAction: Array.isArray(opt.onAction)
        ? opt.onAction
        : opt.onAction === undefined
        ? []
        : [opt.onAction],
      onStateChange: opt.onStateChange ? opt.onStateChange : () => {},
      onReducer: opt.onReducer
        ? opt.onReducer
        : (reducer) => {
            return (action, state) => {
              return reducer(action, state);
            };
          },
      onEffect: opt.onEffect,
      extraReducers: opt.extraReducers ? opt.extraReducers : {},
      extraEnhancers: opt.extraEnhancers,
    };

    return endOptions;
  }

  return app;
}
```

