# 手写 dva-loading

**index.js**

```js
export default function ({ namespace = 'loading' } = {}) {
  return {
    extraReducers: extraReducers(namespace),
    onEffect,
  };
}

//loading显示或隐藏触发的action类型
const show = '@@DVA_LOADING/SHOW',
  hide = '@@DVA_LOADING/HIDE';

//增强effect
// 在原始的effect运行前 分发显示loading的action
//在原始的effect运行后 分发隐藏loading的action
function onEffect(effect, sagaEffects, model, actionType) {
  return function* (action) {
    yield sagaEffects.put({
      type: show,
      payload: {
        namespace: model.namespace,
        actionType,
      },
    });
    yield effect(action);
    yield sagaEffects.put({
      type: hide,
      payload: {
        namespace: model.namespace,
        actionType,
      },
    });
  };
}

//增加一个处理loading的reducer
function extraReducers(namespace) {
  const initial = {
    global: false,
    models: {},
    effects: {},
  };
  return {
    [namespace](state = initial, { type, payload }) {
      switch (type) {
        case show:
          return {
            ...state,
            global: true,
            models: { ...state.models, [payload.namespace]: true },
            effects: { ...state.effects, [payload.actionType]: true },
          };
        case hide:
          return {
            ...state,
            global: resetGlobal(state.models),
            models: { ...state.models, [payload.namespace]: false },
            effects: { ...state.effects, [payload.actionType]: false },
          };

        default:
          return state;
      }
    },
  };
}

//由models对象的属性值是否包含true来控制global的值
function resetGlobal(prevModels) {
  return Object.values(prevModels).includes(true);
}

```

