课前知识

> 1. chrome插件：redux-devtools
> 2. 使用npm安装第三方库：redux-devtools-extension

# redux和router的结合（connected-react-router）

[按照npm的步骤使用即可](https://www.npmjs.com/package/connected-react-router)

用于将redux和react-router进行结合（此第三方库不是开发项目所必需的，重点在于我们是否想要使用仓库管理路由信息）

本质上，router中的某些数据可能会跟数据仓库中的数据进行联动

该组件会将下面的路由数据和仓库保持同步

1. action：它不是redux的action，它表示当前路由跳转的方式（PUSH、POP、REPLACE）
2. location：它记录了当前的地址信息

该库中的内容：操作步骤如下（**注意：**三处history必须为同一个history对象，因此我们可以创建一个history.js用于导出history对象）

1. 添加一个指定的reducer **connectRouter**
2. 添加指定中间件 **routerMiddleware**
3. 使用指定的router代替BrowserRouter **ConnectedRouter**

## connectRouter

这是一个函数，调用它，会返回一个用于管理仓库中路由信息的reducer，该函数需要传递一个参数，参数是一个history对象。该对象，可以使用第三方库history得到。

```js
import { combineReducers } from 'redux';
import counter from './counter';
import movieInfo from './movieInfo';
import { connectRouter } from 'connected-react-router';
import history from '../history';

export default combineReducers({
  counter,
  movieInfo,
  router: connectRouter(history), //添加一个指定的reducer
}); 
```

## routerMiddleware

该函数会返回一个redux中间件，用于拦截一些特殊的action

```js
import { legacy_createStore as createStore, applyMiddleware } from 'redux';
import reducer from './action';
// import logger from 'redux-logger';
import createSagaMiddleware from 'redux-saga';
import sagaTask from './saga';
import { composeWithDevTools } from '@redux-devtools/extension';
import { routerMiddleware } from 'connected-react-router';
import history from './history';

const sagaMiddleware = createSagaMiddleware();
const store = createStore(
  reducer,
  composeWithDevTools(
    applyMiddleware(routerMiddleware(history), sagaMiddleware) //添加指定中间件
  )
);
sagaMiddleware.run(sagaTask);

export default store;
```



## ConnectedRouter

这是一个组件，用于向上下文提供一个history对象和其他的路由信息（与react-router提供的信息一致）

之所以需要新制作一个组件，是因为该库必须保证整个过程使用的是同一个history对象

```js
import React from 'react';
import store from './store';
import { Provider } from 'react-redux';
import { ConnectedRouter } from 'connected-react-router';
import { Route, Switch } from 'react-router-dom';
import Admin from './pages/Admin';
import Login from './pages/Login';
import history from './store/history';

export default function App() {
  return (
    <Provider store={store}>
      <ConnectedRouter history={history}> //使用指定的router
        <Switch>
          <Route path="/login" component={Login}></Route>
          <Route path="/" component={Admin}></Route>
        </Switch>
      </ConnectedRouter>
    </Provider>
  );
}
```



## 一些action创建函数

- push
- replace

在使用 **connected-react-router** 的情况下，我们依然可以使用以前的方式进行动态跳转页面，例如：

```js
import React from 'react';
import './index.css';

export default function AddStudent({ history }) {
  return (
    <div className="add-student-container">
      AddStudent
      <button
        onClick={() => {
          history.push('/course/add'); //利用history api进行动态跳转
        }}
      >
        添加课程
      </button>
    </div>
  );
}
```

**但是，这违背了我们使用仓库管理路由信息的初衷。我们想要跳转页面也是从仓库分发action，而不是直接跳转，要实现仓库和路由的解耦合**

所以正确的使用方式为：

```js
import React from 'react';
import './index.css';
import { push } from 'connected-react-router';
import { connect } from 'react-redux';

function AddStudent(props) {
  return (
    <div className="add-student-container">
      AddStudent
      <button
        onClick={() => {
          props.onlinkToCourseAdd() && props.onlinkToCourseAdd();
        }}
      >
        添加课程
      </button>
    </div>
  );
}

const mapDispatchToProps = (dispatch) => ({
  onlinkToCourseAdd() {
    dispatch(push('/course/add'));
  },
});

export default connect(null,mapDispatchToProps)(AddStudent);

```

