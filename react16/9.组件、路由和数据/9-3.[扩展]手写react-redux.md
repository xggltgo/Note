# 手写 react-redux

**index.js**

用于集中导出核心模块

```js
export { default as Provider } from './Provider';
export { default as connect } from './connect';
```

**context.js**

创建一个上下文

- 供Provider组件提供store中的数据
- 供connect模块使用上下文中的store数据

```js
import { createContext } from 'react';
export default createContext();
```

**Provider.js**

提供一个上下文，将组件的store属性作为上下文中的数据

```js
import React from 'react';
import ctx from './context';

export default function Provider(props) {
  return <ctx.Provider value={props.store}>{props.children}</ctx.Provider>;
}
```

**connect.js**

使用类组件包装原来的组件

```js
import React, { PureComponent } from 'react';
import { bindActionCreators } from 'redux';
import ctx from './context';

export default function (mapStateToProps, mapDispatchToProps) {
  /**
   * 返回一个高阶组件
   */
  return function (Comp) {
    class HOC extends PureComponent {
      //使用上下文
      static contextType = ctx;

      constructor(props, context) {
        super(props, context);
        this.state = this.handleMapStateToProps();
        //监听仓库中的数据变化，得到一个取消监听的函数
        this.unlisten = this.context.subscribe(() => {
          this.setState(this.handleMapStateToProps());
        });
        this.dispatch = this.handleMapDispatchToProps();
      }

      handleMapStateToProps() {
        if (typeof mapStateToProps === 'function') {
          return mapStateToProps(this.context.getState());
        } else {
          return {};
        }
      }

      /**
       * 得到需要传递的事件处理属性
       */
      handleMapDispatchToProps() {
        if (typeof mapDispatchToProps === 'function') {
          return mapDispatchToProps(this.context.dispatch);
        } else if (typeof mapDispatchToProps === 'object') {
          return bindActionCreators(mapDispatchToProps, this.context.dispatch);
        }
      }

      componentWillUnmount() {
        //当组件卸载时，取消监听
        this.unlisten && this.unlisten();
      }

      render() {
        return <Comp {...this.props} {...this.state} {...this.dispatch} />;
      }
    }
    HOC.displayName = Comp.displayName || Comp.name; //类组件的名称和传入的组件一致
    return HOC;
  };
}

```

使用函数组件包装原来的组件

```js
import React, { useContext, useEffect, useState } from 'react';
import { bindActionCreators } from 'redux';
import ctx from './context';

function compare(obj1, obj2) {
  for (const key in obj1) {
    if (obj1[key] !== obj2[key]) {
      return false;
    }
  }
  return true;
}

export default function (mapStateToProps, mapDispatchToProps) {
  /**
   * 返回一个高阶组件
   */
  return function (Comp) {
    //返回一个高阶组件
    function HOC(props) {
      //使用上下文
      const store = useContext(ctx);
      const [state, setState] = useState(
        mapStateToProps && mapStateToProps(store.getState())
      );
      useEffect(() => {
        //监听仓库中的数据变化，得到一个取消监听的函数
        return store.subscribe(() => {
          const newState = mapStateToProps && mapStateToProps(store.getState());
          setState((prevState) => {
            if (compare(prevState, newState)) {
              return prevState;
            } else {
              return newState;
            }
          });
        });
      }, [store]);

      let eventHandler = {};

      if (mapDispatchToProps) {
        eventHandler = handleMapDispatchToProps();
      }

      /**
       * 得到需要传递的事件处理属性
       */
      function handleMapDispatchToProps() {
        if (typeof mapDispatchToProps === 'function') {
          return mapDispatchToProps(store.dispatch);
        } else if (typeof mapDispatchToProps === 'object') {
          return bindActionCreators(mapDispatchToProps, store.dispatch);
        }
      }
      return <Comp {...props} {...state} {...eventHandler} />;
    }
    HOC.displayName = Comp.displayName || Comp.name;
    函数组件的名称和传入的组件一致;
    return HOC;
  };
}
```

