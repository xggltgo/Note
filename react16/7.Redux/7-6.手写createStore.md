# 手写createStore

返回一个对象：

- dispatch：分发一个action
- getState：得到仓库中当前的状态
- subscribe：注册一个监听器，监听器是一个无参函数，该分发一个action之后，会运行注册的监听器。该函数会返回一个函数，用于取消监听

**核心** 内部维护了一个当前使用的reducer和当前仓库中的状态

```js
// createStore.js

/**
 * 返回一个createStore创建的仓库对象
 * @param {Function} reducer
 * @param {any} defaultState 默认状态
 */
export default function (reducer, defaultState) {
  let currentReducer = reducer, //当前使用的reducer
    currentState = defaultState; //当前仓库中的状态

  //内部维护的监听器数组（订阅者）
  let listeners = [];

  /**
   * 分发一个action，调用reducer改变仓库数据
   * @param {Object} action 描述操作的plain-object
   */
  function dispatch(action) {
    //验证action
    if (!isPlainObject(action)) {
      throw new TypeError('action must be a plain object');
    }
    //验证action的type属性是否存在
    if (action.type === undefined) {
      throw new Error('action must has a property of type');
    }
    currentState = currentReducer(currentState, action);
    if (listeners.length) {
      //运行所有的订阅者（监听器）
      for (const listener of listeners) {
        listener();
      }
    }
  }

  function getState() {
    return currentState;
  }

  /**
   * 添加一个监听器（订阅器）
   * @param {Function} listener 无参函数
   */
  function subscribe(listener) {
    listeners.push(listener);
    let isRemove = false; //是否已经移除掉了
    return () => {
      if (isRemove) {
        return;
      }
      listeners = listeners.filter((lt) => lt !== listener);
      isRemove = true;
    };
  }

  //首次调用createStore,分发一个特殊的action
  dispatch({ type: `@@Redux/INIT${createRandomString(7)}` });

  return {
    dispatch,
    getState,
    subscribe,
  };
}

//以下为一些内部辅助函数

function createRandomString(length) {
  return Math.random()
    .toString(32)
    .substring(2, length + 2)
    .split('')
    .join('.');
}

/**
 * 判断某个对象是否是一个plain-object
 * @param {*} obj
 */
function isPlainObject(obj) {
  if (typeof obj !== 'object') {
    return false;
  }
  return Object.getPrototypeOf(obj) === Object.prototype;
}
```



