# 声明文件

## 概述

> 声明文件：以`.d.ts`结尾的文件

声明文件有什么作用？为原有的JS文件（代码）提供类型声明

声明文件的位置：

- 放置到ts配置文件中所配置的需要编译的文件夹中 `"include": ["./src"]`
- 放置到node_modules/@types文件夹中
- 手动配置编译选项`"typeRoots": ["./types"]`，表示声明文件存放的目录(配置此选项后，前两种方式失效)
- 与JS文件所在目录相同的`同名.d.ts`文件。即用ts代码书写的工程发布之后的格式

## 编写声明文件

手动编写 or 自动生成

### 自动生成

自动生成对应的场景：工程原本就是使用TS进行开发的

此时，配置编译选项 `"declaration": true`，则会在编译结果中生成每个JS文件对应的类型声明文件。

如果还需要开启源码地图，则配置编译选项 `"sourceMap": true`

### 手动生成

手动生成对应的场景：工程中原有的JS文件太多，将其重构为TS文件成本较高，此时可以手动编写其对应的声明文件

#### 全局声明

**index.ts**

```typescript
setTimeout(() => {
  console.log('123');
}, 1000);
```

**global.d.ts**

```typescript
interface Console {
  log: (p?: any) => void;
}
declare var console: Console;

declare function setTimeout(handler: () => void, time: number): number;
```

利用 namespace 描述 console

> namespace：表示命名空间，可以理解为一个对象，命名空间中的内容，需要通过`命名空间.成员名`进行访问

```typescript
declare namespace console {
  function log(p?: any): void;
} 
```

#### 模块声明

**index.ts**

```typescript
import _ from 'lodash'; // ts错误提示：无法找到模块“lodash”的声明文件。

const result = _.chunk([1, 2, 3, 4, 5, 6, 7], 2);
console.log(result);
```

**lodash.d.ts**

```typescript
// 声明模块
declare module 'lodash' {
  export function chunk<T>(origin: T[], range: number): T[][];
}
```

但是，就算书写好了loadsh的声明文件，使用`npm run dev`时，控制台会报错

```json
"dev": "nodemon --watch src -e ts --exec ts-node ./src/index.ts"
```

这是因为 ts-node只会编译指定的启动文件，即我们配置的`./src/index.ts`

为了解决这个问题，我们需要手动指定哪些位置的声明文件需要读取，配置编译选项`"typeRoots": ["./node_modules/@types", "./src"]`

#### 三斜线指令

在一个声明文件中包含另一个声明文件，类似导入

```typescript
/// <reference path="../lodash.d.ts" />
```



## 发布

1. 当前工程使用ts开发

编译完成后，将编译结果所在文件夹直接发布到npm上即可

2. 为其他第三方库开发的声明文件

发布到@types/**中。

1） 进入github的开源项目：https://github.com/DefinitelyTyped/DefinitelyTyped

2） fork到自己的开源库中

3） 从自己的开源库中克隆到本地

4） 本地新建分支（例如：mylodash4.3），在新分支中进行声明文件的开发

    在types目录中新建文件夹，在新的文件夹中开发声明文件

5） push分支到你的开源库

6） 到官方的开源库中，提交pull request

7） 等待官方管理员审核（1天）

审核通过之后，会将你的分支代码合并到主分支，然后发布到npm。

之后，就可以通过命令```npm install @types/你发布的库名```